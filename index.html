
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cycloidal Gear Generator</title>
<style>
  body {
    font-family: sans-serif;
    margin: 20px;
  }
  .controls {
    margin-bottom: 20px;
  }
  label {
    margin-right: 10px;
  }
  input {
    width: 60px;
    margin-right: 20px;
  }
  #gearSVG {
    border: 1px solid #ccc;
    width: 500px;
    height: 500px;
    display: block;
    margin-top: 20px;
  }
  button {
    margin-right: 10px;
    padding: 6px 12px;
  }
</style>
</head>
<body>
<h1>Cycloidal Gear Generator</h1>
<div class="controls">
  <label>Number of Pins: <input type="number" id="numPins" value="10"></label>
  <label>Pin Radius (mm): <input type="number" id="pinRadius" value="2.5" step="0.1"></label>
  <label>Pin Circle Radius (mm): <input type="number" id="pinCircleRadius" value="50" step="0.1"></label>
  <label>Contraction (mm): <input type="number" id="contraction" value="2" step="0.1"></label>
  <button id="generateBtn">Generate Gear</button>
  <button id="downloadBtn">Download SVG (Just Profile)</button>
</div>

<svg id="gearSVG" xmlns="http://www.w3.org/2000/svg" viewBox="-60 -60 120 120">
  <!-- For visualization only -->
  <circle id="cycloidBaseCircle" cx="0" cy="0" r="0" stroke-dasharray="4" fill="none" stroke="gray"/>
  <circle id="rollingCircle" cx="0" cy="0" r="0" stroke="black" fill="none"/>
  <g id="pinsGroup" fill="none" stroke="blue"></g>

  <!-- The main epicycloid path -->
  <path id="epicycloidPath" stroke="red" fill="none"/>
</svg>

<script>
function deg2rad(d) { return d * Math.PI/180; }

function generateGear() {
  const numberOfPins = parseFloat(document.getElementById('numPins').value);
  const pinRadius = parseFloat(document.getElementById('pinRadius').value);
  const pinCircleRadius = parseFloat(document.getElementById('pinCircleRadius').value);
  const contraction = parseFloat(document.getElementById('contraction').value);

  // Derived values
  const rollingCircleRadius = pinCircleRadius / numberOfPins;
  const reductionRatio = numberOfPins - 1;
  const cycloidBaseRadius = reductionRatio * rollingCircleRadius;

  // Compute epicycloid points
  let epicycloid_points = [];
  for (let angle = 0; angle <= 360; angle++) {
    const rad = deg2rad(angle);
    const xCenter = (cycloidBaseRadius + rollingCircleRadius)*Math.cos(rad);
    const yCenter = (cycloidBaseRadius + rollingCircleRadius)*Math.sin(rad);

    const xPoint = xCenter + (rollingCircleRadius - contraction)*Math.cos(deg2rad(numberOfPins*angle));
    const yPoint = yCenter + (rollingCircleRadius - contraction)*Math.sin(deg2rad(numberOfPins*angle));

    epicycloid_points.push({x: xPoint, y: yPoint});
  }
	console.log(epicycloid_points)

  // Create the path for the epicycloid
  let d = `M ${epicycloid_points[0].x},${epicycloid_points[0].y}`;
  for (let i = 1; i < epicycloid_points.length; i++) {
    d += ` L ${epicycloid_points[i].x},${epicycloid_points[i].y}`;
  }
  d += 'Z';

  document.getElementById('epicycloidPath').setAttribute('d', d);

  // Update reference circles (visual only)
  document.getElementById('cycloidBaseCircle').setAttribute('r', cycloidBaseRadius);
  document.getElementById('rollingCircle').setAttribute('r', rollingCircleRadius);

  // Draw pin circles (visual only)
  const pinsGroup = document.getElementById('pinsGroup');
  while (pinsGroup.firstChild) {
    pinsGroup.removeChild(pinsGroup.firstChild);
  }

  for (let i = 0; i <= numberOfPins; i++) {
    const pinAngle = deg2rad((360/numberOfPins)*i);
    const px = pinCircleRadius * Math.cos(pinAngle) + rollingCircleRadius - contraction;
    const py = pinCircleRadius * Math.sin(pinAngle);
    const circle = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
    circle.setAttribute('cx', px);
    circle.setAttribute('cy', py);
    circle.setAttribute('r', pinRadius);
    pinsGroup.appendChild(circle);
  }

  // Adjust the viewBox dynamically so everything fits
  adjustViewBox(epicycloid_points, pinCircleRadius, pinRadius);
}

function adjustViewBox(points, pinCircleRadius, pinRadius) {
  // Compute bounding box of all points + pins
  let minX = Infinity, maxX = -Infinity;
  let minY = Infinity, maxY = -Infinity;

  points.forEach(p => {
    if (p.x < minX) minX = p.x;
    if (p.x > maxX) maxX = p.x;
    if (p.y < minY) minY = p.y;
    if (p.y > maxY) maxY = p.y;
  });

  // Add some padding
  const padding = pinCircleRadius * 1.5;
  minX -= padding;
  maxX += padding;
  minY -= padding;
  maxY += padding;

  const width = maxX - minX;
  const height = maxY - minY;
  const svg = document.getElementById('gearSVG');
  svg.setAttribute('viewBox', `${minX} ${minY} ${width} ${height}`);
}

function downloadSVG() {
  // We want only the epicycloidPath in the exported file
  const epicycloidPath = document.getElementById('epicycloidPath');
  const d = epicycloidPath.getAttribute('d');

  // Create a minimal SVG with only this path
  // We'll use the current viewBox so the exported file is scaled similarly
  const gearSVG = document.getElementById('gearSVG');
  const viewBox = gearSVG.getAttribute('viewBox');

  const minimalSVG = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="${viewBox}">
  <path d="${d}" fill="none" stroke="black"/>
</svg>`;

  const blob = new Blob([minimalSVG], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = "cycloidal_gear.svg";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.getElementById('generateBtn').addEventListener('click', generateGear);
document.getElementById('downloadBtn').addEventListener('click', downloadSVG);

// Generate once at load
generateGear();
</script>
</body>
</html>
